<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memories with G - Collaborative Photobook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Shadows+Into+Light&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom style for Scrapbook layout text */
        .font-handwriting {
            font-family: 'Shadows Into Light', cursive;
        }
        /* Page size aspect ratio */
        .photobook-page {
            aspect-ratio: 1.4 / 1;
        }
    </style>
    <script type="module">
        import { createIcons, icons } from "https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js";
        window.lucide = { createIcons, icons };
    </script>
</head>
<body class="antialiased">

<div id="app" class="flex h-screen overflow-hidden">
    </div>

<script>
    // Firebase client config (safe to include in frontend)
    window.__firebase_config = {
        apiKey: "AIzaSyAaymSDniDFlRfLA-DnYbHWr0SXNEZPQGU",
        authDomain: "memories-with-g.firebaseapp.com",
        projectId: "memories-with-g",
        storageBucket: "memories-with-g.firebasestorage.app",
        messagingSenderId: "94253928446",
        appId: "1:94253928446:web:b536c5b730da60cd57faaf"
    };
    // Optional: default app/book id used by the demo
    window.__app_id = "memories-with-g";
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- Configuration and Initialization ---

    // Global variables provided by the environment (must be accessed safely)
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : (typeof __app_id !== 'undefined' ? __app_id : 'default-photobook-id');
    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : (typeof __firebase_config !== 'undefined' ? __firebase_config : {});
    // Injected custom token for Firebase authentication
    const initialAuthToken = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJodHRwczovL2lkZW50aXR5dG9vbGtpdC5nb29nbGVhcGlzLmNvbS9nb29nbGUuaWRlbnRpdHkuaWRlbnRpdHl0b29sa2l0LnYxLklkZW50aXR5VG9vbGtpdCIsImlhdCI6MTc2MzU3OTkzOSwiZXhwIjoxNzYzNTgzNTM5LCJpc3MiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BtZW1vcmllcy13aXRoLWcuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BtZW1vcmllcy13aXRoLWcuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJ1aWQiOiJkZXYtdXNlci0xNzYzNTc5OTM5NzE4In0.ZgexbzZ98WRJp-zpmUG_hzO4F99Dr27uavQpwpKqDCsolYCxRd5_2t2zRn6qhAsnqk4Ji4RI9eJ5uhTWkLwfvud2iNeIVyXH-2U7-VkKlGY4vC4s_SNZeegVBpVHo35nU4Ob7duWt7rhXZgrvL0zz9cqT2oMLX_kuxqYpZh1BJvjnY5NQgTFhKBocPprD8j0DEU8GL_XQXPscWAqMvp6O1VLxygcKnScYdbPAlygbStpXNYuHJiWxCz4pCyi8njfxBuQwwMcWXidgpeynuP9e6WVAA-XwP4UR8w8R5jXxeJAoZb6V8aEStPC7AE3KwzmhYg1oHyHvXuq2keTlk2bTQ";

    let app, db, auth;
    let currentUserId = null;
    let pages = [];
    let activePageIndex = 0;
    // Default to preview mode for visitors. Enable editing only when URL has `?edit=1`
    // or when an environment-global `window.__is_editor` is provided.
    let isEditing = (function(){
        try {
            const urlEdit = new URLSearchParams(window.location.search).get('edit');
            return urlEdit === '1' || (typeof window.__is_editor !== 'undefined' && !!window.__is_editor);
        } catch (e) {
            return (typeof window.__is_editor !== 'undefined' && !!window.__is_editor);
        }
    })();
    let isLoading = true;
    let isSaving = false;
    let saveStatus = null; // 'success', 'error'
    let saveErrorMessage = null; // last save error message for UI
    let cloudSaveFailed = false; // whether cloud saves/listener have failed (show banner)

    const INITIAL_PAGES = [
        { id: 1, layout: 'hero', content: { title: 'Memories with G', text: 'This is our shared digital photobook. All changes are saved automatically and seen by everyone with the link!', photos: [], captions: [] } },
    ];

    // Lightweight SVG icon helper (simple placeholders to avoid external API mismatch)
    const IconSVG = (name, size = 16, cls = '') => {
        const cattr = cls ? ` class="${cls}"` : '';
        const s = size;
        switch (name) {
            case 'Loader2':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9"/></svg>`;
            case 'Plus':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>`;
            case 'ChevronLeft':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>`;
            case 'ChevronRight':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6"/></svg>`;
            case 'Image':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="14" rx="2"/><circle cx="9" cy="8" r="1"/><path d="M21 21l-6-6-4 4-3-3-2 2"/></svg>`;
            case 'Upload':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 5 17 10"/><line x1="12" y1="5" x2="12" y2="19"/></svg>`;
            case 'Save':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>`;
            case 'AlertTriangle':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`;
            case 'Edit3':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>`;
            case 'Eye':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>`;
            case 'Maximize':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/></svg>`;
            case 'Columns':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="18"/><rect x="14" y="3" width="7" height="18"/></svg>`;
            case 'Grid':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="8" height="8"/><rect x="13" y="3" width="8" height="8"/><rect x="3" y="13" width="8" height="8"/><rect x="13" y="13" width="8" height="8"/></svg>`;
            case 'Smile':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>`;
            case 'MoveUp':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>`;
            case 'MoveDown':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`;
            case 'Trash2':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>`;
            case 'Book':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4v15.5A2.5 2.5 0 0 0 6.5 22H20V4z"/></svg>`;
            case 'Users':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
            case 'Copy':
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
            default:
                return `<svg${cattr} xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>`;
        }
    };

    // Debounce timer for auto-saving
    let saveTimeout = null;
    
    // Reference to the file input element
    let fileInputRef;
    let activePhotoIndex = null;
    let storage = null;
    let lastUpdatedBy = null;
    let lastUpdatedAt = null;

    // --- Firebase and Data Logic ---

    const getBookRef = () => {
        if (db) {
            // Use the public path for collaborative data (explicit path segments)
            return doc(db, 'artifacts', String(appId), 'public', 'data', 'photobook', 'shared_book');
        }
        return null;
    };

    const saveBook = async (currentPages) => {
        const bookRef = getBookRef();
        if (!bookRef) return;
        
        isSaving = true;
        saveStatus = null;
        saveErrorMessage = null;
        renderApp();

        try {
            await setDoc(bookRef, { 
                pages: currentPages,
                updatedBy: currentUserId,
                updatedAt: new Date().toISOString()
            }, { merge: true });
            saveStatus = 'success';
            console.log("Photobook saved successfully to shared collection.");
            // update metadata shown in the UI
            lastUpdatedBy = currentUserId;
            lastUpdatedAt = new Date().toISOString();
            cloudSaveFailed = false;
            // Clear any local fallback since save succeeded
            try { localStorage.removeItem(`photobook:${appId}`); } catch (e) {}
        } catch (error) {
            console.error("Error saving shared photobook:", error?.message || error);
            saveStatus = 'error';
            cloudSaveFailed = true;
            saveErrorMessage = error?.message || String(error);
            // Persist locally as a fallback so user's uploads aren't lost
            try {
                localStorage.setItem(`photobook:${appId}`, JSON.stringify({ pages: currentPages, updatedAt: new Date().toISOString() }));
                console.log('Saved photobook to localStorage fallback.');
            } catch (e) {
                console.error('Failed to write local fallback:', e?.message || e);
            }
        } finally {
            isSaving = false;
            renderApp();
            setTimeout(() => {
                saveStatus = null;
                saveErrorMessage = null;
                renderApp();
            }, 3000); 
        }
    };

    const debouncedSave = (newPages) => {
        pages = newPages; // Update the global state immediately
        renderApp(); // Rerender immediately to show user change
        // Keep a local copy immediately so changes survive reloads if cloud save fails
        try { localStorage.setItem(`photobook:${appId}`, JSON.stringify({ pages: pages, updatedAt: new Date().toISOString() })); } catch (e) {}
        
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        saveTimeout = setTimeout(() => saveBook(pages), 1000);
    };

    const loadBook = () => {
        const bookRef = getBookRef();
        if (!bookRef) return;

        // Attach real-time listener
        onSnapshot(bookRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().pages) {
                console.log("Loading shared photobook from Firestore.");
                const loadedPages = docSnap.data().pages;
                // surface metadata
                lastUpdatedBy = docSnap.data().updatedBy || null;
                lastUpdatedAt = docSnap.data().updatedAt || null;
                cloudSaveFailed = false;
                pages = loadedPages;
                activePageIndex = Math.min(activePageIndex, loadedPages.length - 1);
                // Clear local fallback since we have a server copy
                try { localStorage.removeItem(`photobook:${appId}`); } catch (e) {}
            } else if (pages.length === 0) { 
                console.log("No data found. Initializing default shared photobook.");
                pages = INITIAL_PAGES;
            }
            isLoading = false;
            renderApp();
        }, (error) => {
            console.error("Error listening to photobook data:", error?.message || error);
            cloudSaveFailed = true;
            // Try loading a local fallback so user doesn't lose recent uploads
            try {
                const fallback = localStorage.getItem(`photobook:${appId}`);
                if (fallback) {
                    const parsed = JSON.parse(fallback);
                    if (parsed && parsed.pages) {
                        pages = parsed.pages;
                        console.log('Loaded photobook from localStorage fallback.');
                    }
                }
            } catch (e) {
                console.error('Failed to load local fallback:', e?.message || e);
            }
            isLoading = false;
            renderApp();
        });
    };

    const initializeFirebase = async () => {
        if (!Object.keys(firebaseConfig).length) {
            console.error("Firebase config is missing.");
            isLoading = false;
            renderApp();
            return;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        // initialize storage (may fail if storage package not available)
        try { storage = getStorage(app); } catch (e) { storage = null; }

        // Authentication
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth); 
            }
        } catch (error) {
            console.error("Firebase authentication failed:", error);
        }

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            currentUserId = user?.uid || `anonymous-${appId}`;
            if (db) {
                loadBook(); // Start loading data once authenticated/identified
            }
        });
    };

    // --- App Logic Handlers ---

    // FIX APPLIED HERE
    const handleAddPage = () => {
        const newPage = {
            id: Date.now(),
            layout: 'hero',
            content: { title: 'New Shared Memory', text: 'Add a description here...', photos: [], captions: [] }
        };
        
        // 1. Create the new array
        const newPages = [...pages, newPage]; 
        
        // 2. Update the global state immediately
        pages = newPages;
        
        // 3. Set the active index to the last item (the one we just added)
        activePageIndex = pages.length - 1; 

        // 4. Trigger the debounced save with the new array (which will call renderApp)
        debouncedSave(pages); 
    };

    const handleDeletePage = () => {
        if (pages.length <= 1) return; 
        const newPages = pages.filter((_, i) => i !== activePageIndex);
        activePageIndex = Math.max(0, activePageIndex - 1);
        debouncedSave(newPages);
    };

    const handleMovePage = (direction) => {
        if ((direction === 'up' && activePageIndex > 0) || (direction === 'down' && activePageIndex < pages.length - 1)) {
            const newPages = [...pages];
            const targetIndex = direction === 'up' ? activePageIndex - 1 : activePageIndex + 1;
            [newPages[activePageIndex], newPages[targetIndex]] = [newPages[targetIndex], newPages[activePageIndex]];
            activePageIndex = targetIndex;
            debouncedSave(newPages);
        }
    };

    const handleUpdateContent = (field, value, index = null) => {
        const newPages = [...pages];
        const page = newPages[activePageIndex];
        
        if (!page.content) page.content = { title: '', text: '', photos: [], captions: [] };

        if (field === 'caption') {
            if (!page.content.captions) page.content.captions = [];
            page.content.captions[index] = value;
        } else if (field === 'title' || field === 'text') {
            page.content[field] = value;
        }
        
        debouncedSave(newPages);
    };
    
    const handleChangeLayout = (type) => {
        const newPages = [...pages];
        newPages[activePageIndex].layout = type;
        debouncedSave(newPages);
    };

    // Image Upload Logic
    const triggerUpload = (photoIndex) => {
        activePhotoIndex = photoIndex;
        fileInputRef.click();
    };

    const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (file && activePhotoIndex !== null) {
            // If Storage is available, upload there and store a small URL
            if (storage) {
                const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                const path = `photobooks/${appId}/${Date.now()}_${safeName}`;
                const sRef = storageRef(storage, path);
                try {
                    await uploadBytes(sRef, file);
                    const url = await getDownloadURL(sRef);
                    const newPages = [...pages];
                    // ensure page exists
                    if (!newPages[activePageIndex]) newPages[activePageIndex] = { id: Date.now(), layout: 'hero', content: { title: '', text: '', photos: [], captions: [] } };
                    const page = newPages[activePageIndex];
                    if (!page.content.photos) page.content.photos = [];
                    page.content.photos[activePhotoIndex] = url;
                    debouncedSave(newPages);
                    } catch (err) {
                    console.error('Upload to Storage failed, falling back to base64:', err?.message || err);
                    // fallback to base64 data URL
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const newPages = [...pages];
                        // Ensure we create the page at the active PAGE index (not the photo index)
                        if (!newPages[activePageIndex]) newPages[activePageIndex] = { id: Date.now(), layout: 'hero', content: { title: '', text: '', photos: [], captions: [] } };
                        const page = newPages[activePageIndex];
                        if (!page.content.photos) page.content.photos = [];
                        page.content.photos[activePhotoIndex] = event.target.result;
                        debouncedSave(newPages);
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                // No storage available — keep existing behavior (base64 fallback)
                const reader = new FileReader();
                reader.onload = (event) => {
                    const newPages = [...pages];
                    if (!newPages[activePageIndex]) newPages[activePageIndex] = { id: Date.now(), layout: 'hero', content: { title: '', text: '', photos: [], captions: [] } };
                    const page = newPages[activePageIndex];
                    if (!page.content.photos) page.content.photos = [];
                    page.content.photos[activePhotoIndex] = event.target.result;
                    debouncedSave(newPages);
                };
                reader.readAsDataURL(file);
            }
        }
        e.target.value = null; 
    };
    
    // Copy the App ID to the clipboard
    const copyAppIdToClipboard = () => {
        const shareUrl = `${location.origin}${location.pathname}?id=${encodeURIComponent(appId)}`;
        const tempInput = document.createElement('textarea');
        tempInput.value = shareUrl;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        const copyMessage = document.getElementById('copy-message');
        if (copyMessage) {
            copyMessage.textContent = 'Link copied!';
            copyMessage.classList.remove('opacity-0');
            setTimeout(() => copyMessage.classList.add('opacity-0'), 1500);
        }
    };

    // --- Renderer Functions (HTML Generation) ---

    const escapeHtml = (str = '') => {
        return String(str === null || typeof str === 'undefined' ? '' : str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    };

    const formatDate = (iso) => {
        try { return new Date(iso).toLocaleString(); } catch (e) { return iso; }
    };

    // Generic Input/Textarea component for editing
    const EditableText = (type, value, onChange, className, placeholder, isEditing, style = '', tag = 'input', index = null) => {
        if (isEditing) {
            const indexArg = index !== null ? `, ${index}` : '';

            if (tag === 'textarea') {
                return `<textarea oninput="handleUpdateContent('${type}', this.value${indexArg})" class="${className}" placeholder="${placeholder}" style="${style}">${value}</textarea>`;
            } else { // Default to input
                 return `<input type="text" oninput="handleUpdateContent('${type}', this.value${indexArg})" class="${className}" placeholder="${placeholder}" style="${style}" value="${value.replace(/"/g, '&quot;')}" />`;
            }
        } else {
            if (tag === 'textarea') {
                // For view mode, render textarea content as multi-line (escaped)
                return `<p class="${className}" style="white-space: pre-line; ${style}">${escapeHtml(value || placeholder)}</p>`;
            } else {
                 return `<h2 class="${className}" style="${style}">${escapeHtml(value || placeholder)}</h2>`;
            }
        }
    };

    const PhotoSlot = (photoUrl, photoIndex, isEditing, layoutClass = "") => {
        const placeholderContent = `
            <div class="text-gray-400 flex flex-col items-center">
                ${IconSVG('Image', 24)}
                <span class="text-sm">Add Photo</span>
            </div>
        `;
        
        const photoContent = photoUrl 
            ? `<img src="${photoUrl}" alt="Memory Photo" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/150x100/F0F4F8/9CA3AF?text=Image+Failed';" />`
            : placeholderContent;

        const uploadOverlay = isEditing ? `
            <div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 hover:opacity-100 transition-opacity cursor-pointer" onclick="triggerUpload(${photoIndex})">
                ${IconSVG('Upload', 24, 'text-white drop-shadow-md')}
            </div>
        ` : '';

        return `
            <div class="relative flex-1 bg-gray-100 rounded-lg overflow-hidden group border border-gray-200 ${layoutClass} flex items-center justify-center">
                ${photoContent}
                ${uploadOverlay}
            </div>
        `;
    };
    
    // Caption input field
    const CaptionInput = (caption, photoIndex, isEditing, extraClass = "") => {
        if (isEditing) {
            return `
                <input
                    type="text"
                    value="${caption ? caption.replace(/"/g, '&quot;') : ''}"
                    oninput="handleUpdateContent('caption', this.value, ${photoIndex})"
                    class="w-full text-xs text-gray-500 text-center bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-400 outline-none ${extraClass}"
                    placeholder="Caption..."
                />
            `;
        } else if (caption) {
            return `<p class="text-xs text-gray-500 text-center ${extraClass}">${escapeHtml(caption)}</p>`;
        }
        return '';
    };

    // --- Layout Renderers (HTML) ---
    const renderLayout = (page) => {
        const { layout, content } = page;
        const photos = content.photos || [];
        const captions = content.captions || [];

        const props = {
            title: content.title || '',
            text: content.text || '',
            isEditing: isEditing,
        };

        switch (layout) {
            case 'hero': 
                return `
                    <div class="flex flex-col h-full p-8 bg-white shadow-sm">
                        <div class="flex-1 relative mb-6">
                            ${PhotoSlot(photos[0], 0, props.isEditing, "h-full w-full")}
                        </div>
                        <div class="space-y-4 text-center">
                            ${EditableText('title', props.title, null, 'w-full text-3xl font-serif text-center text-gray-800 border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none bg-transparent transition-colors placeholder-gray-300', 'Memory Title', props.isEditing)}
                            ${EditableText('text', props.text, null, 'w-full text-gray-600 text-center border-l-2 border-transparent hover:border-gray-300 focus:border-blue-500 outline-none bg-transparent resize-none h-24 p-2 placeholder-gray-300', 'Write about this moment...', props.isEditing, '', 'textarea')}
                        </div>
                    </div>
                `;

            case 'split':
                return `
                    <div class="flex flex-row h-full bg-white shadow-sm">
                        <div class="w-1/2 p-6 relative group flex flex-col">
                            ${PhotoSlot(photos[0], 0, props.isEditing)}
                            <div class="mt-3 h-6">
                                ${CaptionInput(captions[0], 0, props.isEditing)}
                            </div>
                        </div>

                        <div class="w-1/2 p-8 flex flex-col justify-center space-y-6">
                            ${EditableText('title', props.title, null, 'w-full text-4xl font-serif text-gray-800 border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none bg-transparent', 'Title', props.isEditing)}
                            ${EditableText('text', props.text, null, 'w-full h-64 text-gray-600 text-lg leading-relaxed border-l-2 border-transparent hover:border-gray-300 focus:border-blue-500 outline-none bg-transparent resize-none p-2', 'Tell the story...', props.isEditing, '', 'textarea')}
                        </div>
                    </div>
                `;

            case 'grid':
                const gridItems = [0, 1, 2, 3].map(index => `
                    <div class="flex flex-col h-full">
                        ${PhotoSlot(photos[index], index, props.isEditing)}
                        <div class="mt-2 h-6">
                            ${CaptionInput(captions[index], index, props.isEditing)}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="h-full p-8 bg-white flex flex-col">
                        <div class="mb-6 text-center">
                            ${EditableText('title', props.title, null, 'text-2xl font-medium text-gray-800 text-center bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none', 'Gallery Title', props.isEditing, '', 'input')}
                        </div>
                        <div class="grid grid-cols-2 grid-rows-2 gap-6 flex-1">
                            ${gridItems}
                        </div>
                    </div>
                `;
            case 'scrapbook':
                const rotations = ['-rotate-2', 'rotate-3', '-rotate-1'];
                const photoPositions = [
                    { top: '0%', left: '5%' },
                    { top: '10%', left: '50%' },
                    { top: '45%', left: '25%' },
                ];
                
                const scrapbookPhotos = [0, 1, 2].map(index => `
                    <div 
                        class="absolute p-3 bg-white shadow-md transform transition-transform hover:z-20 hover:scale-105 ${rotations[index]}"
                        style="width: 45%; height: 50%; top: ${photoPositions[index].top}; left: ${photoPositions[index].left};"
                    >
                        <div class="w-full h-[80%] bg-gray-100 overflow-hidden relative group">
                            ${PhotoSlot(photos[index], index, props.isEditing)}
                        </div>
                        <div class="h-[20%] flex items-center justify-center">
                            ${CaptionInput(captions[index], index, props.isEditing, 'font-handwriting text-base')}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="h-full p-6 bg-stone-50 shadow-inner flex flex-col relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-32 h-32 bg-yellow-100 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
                        
                        <div class="z-10 mb-8 pl-4">
                            ${EditableText('title', props.title, null, 'text-4xl font-handwriting text-gray-800 bg-transparent border-b-2 border-transparent hover:border-stone-300 focus:border-stone-500 outline-none w-full', 'My Adventure', props.isEditing, 'font-family: \'Shadows Into Light\', cursive;')}
                        </div>

                        <div class="flex-1 relative">
                            ${scrapbookPhotos}
                        </div>
                        
                        <div class="mt-4 p-4 border-t-2 border-stone-200 border-dashed">
                            ${EditableText('text', props.text, null, 'w-full h-20 text-gray-700 bg-transparent outline-none resize-none font-handwriting text-lg', 'Notes...', props.isEditing, 'font-family: \'Shadows Into Light\', cursive;', 'textarea')}
                        </div>
                    </div>
                `;
            default:
                return `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        Error: Unknown Layout Type.
                    </div>
                `;
        }
    };
    
    // Main Render Loop
    const renderApp = () => {
        const appElement = document.getElementById('app');
        if (!appElement) return;

        // Build a full, shareable URL for this book (used in the sidebar)
        const shareUrl = `${location.origin}${location.pathname}?id=${encodeURIComponent(appId)}`;

        if (isLoading) {
            appElement.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen w-full">
                    ${IconSVG('Loader2', 48, 'animate-spin text-blue-500 mb-4')}
                    <p class="text-gray-600">Connecting to shared memories...</p>
                </div>
            `;
            return;
        }
        // Banner shown when cloud saves/listener have failed
        let bannerHtml = '';
        if (cloudSaveFailed) {
            bannerHtml = `
                <div id="cloud-banner" class="w-full bg-yellow-400 text-black p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <strong>Cloud saves unavailable</strong>
                        <span class="text-sm opacity-90 max-w-xl truncate" title="${saveErrorMessage || ''}">${saveErrorMessage || 'Using local fallback for now.'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="retrySaveFromLocal()" class="px-3 py-1 bg-white text-yellow-600 rounded">Retry</button>
                        <button onclick="dismissCloudBanner()" class="px-3 py-1 bg-white text-yellow-600 rounded">Dismiss</button>
                    </div>
                </div>
            `;
        }
        
        let activePage = pages[activePageIndex];

        // FIX APPLIED HERE: Clamping the index before checking activePage
        if (activePageIndex >= pages.length && pages.length > 0) {
            activePageIndex = pages.length - 1;
            activePage = pages[activePageIndex];
        }

        if (!activePage) {
            // This fallback should only run if the array is truly empty (e.g. initialization failed)
            if (pages.length === 0) {
                pages = INITIAL_PAGES.slice();
                activePageIndex = 0;
                activePage = pages[0];
            } else {
                // If index was wrong but array has pages, fall back to index 0
                activePageIndex = 0; 
                activePage = pages[0];
            }
        }
        
        // Render Save Status Indicator
        let saveStatusIndicator = '';
        if (isSaving) {
            saveStatusIndicator = `
                <div class="flex items-center gap-2 text-sm font-medium px-4 py-2 bg-yellow-400 text-gray-800 rounded-md">
                    ${IconSVG('Loader2', 16, 'animate-spin')}
                    Saving...
                </div>
            `;
        } else if (saveStatus === 'success') {
            saveStatusIndicator = `
                <div class="flex items-center gap-2 text-sm font-medium px-4 py-2 bg-green-500 text-white rounded-md shadow-lg">
                    ${IconSVG('Save', 16)}
                    Saved!
                </div>
            `;
        } else if (saveStatus === 'error') {
            saveStatusIndicator = `
                <div class="flex flex-col items-start gap-2 text-sm font-medium px-4 py-2 bg-red-500 text-white rounded-md shadow-lg">
                    <div class="flex items-center gap-2">
                        ${IconSVG('AlertTriangle', 16)}
                        <span>Error saving</span>
                    </div>
                    <div class="text-xs opacity-90 max-w-xs truncate" title="${saveErrorMessage || ''}">${saveErrorMessage || 'Save failed'}</div>
                    <div class="pt-1">
                        <button onclick="retrySaveFromLocal()" class="px-2 py-1 text-sm bg-white text-red-600 rounded border">Retry from local</button>
                    </div>
                </div>
            `;
        } else {
             saveStatusIndicator = `
                 <button 
                    onclick="saveBook(pages)"
                    class="px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 bg-green-500 text-white hover:bg-green-600 transition-colors"
                >
                    ${IconSVG('Save', 16)}
                    Save Now
                </button>
             `;
        }

        const toolbarHtml = `
            <div class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-20">
                <div class="flex items-center gap-4">
                    <button 
                        id="toggle-edit-btn"
                        class="px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 transition-colors ${
                            !isEditing 
                            ? 'bg-blue-600 text-white shadow-md' 
                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                        }"
                    >
                        ${!isEditing ? IconSVG('Edit3', 16) : IconSVG('Eye', 16)}
                        ${!isEditing ? 'Edit Book' : 'Preview Mode'}
                    </button>
                    <div id="save-status-container" class="relative">${saveStatusIndicator}</div>
                    <div class="ml-4 text-xs text-gray-500">Last: ${lastUpdatedAt ? formatDate(lastUpdatedAt) : '—'} by <span class="font-mono">${escapeHtml(lastUpdatedBy || '—')}</span></div>
                </div>

                ${isEditing ? `
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
                            <button onclick="handleChangeLayout('hero')" class="p-2 rounded-md ${activePage.layout === 'hero' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:bg-gray-200'}" title="Hero Layout">
                                ${IconSVG('Maximize', 18)}
                            </button>
                            <button onclick="handleChangeLayout('split')" class="p-2 rounded-md ${activePage.layout === 'split' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:bg-gray-200'}" title="Split Layout">
                                ${IconSVG('Columns', 18)}
                            </button>
                            <button onclick="handleChangeLayout('grid')" class="p-2 rounded-md ${activePage.layout === 'grid' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:bg-gray-200'}" title="Grid Gallery">
                                ${IconSVG('Grid', 18)}
                            </button>
                            <button onclick="handleChangeLayout('scrapbook')" class="p-2 rounded-md ${activePage.layout === 'scrapbook' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:bg-gray-200'}" title="Scrapbook">
                                ${IconSVG('Smile', 18)}
                            </button>
                        </div>
                        <div class="w-px h-6 bg-gray-300 mx-2"></div>
                        <div class="flex gap-1">
                            <button onclick="handleMovePage('up')" ${activePageIndex === 0 ? 'disabled' : ''} class="p-2 text-gray-500 hover:bg-gray-100 rounded-md disabled:opacity-30">
                                ${IconSVG('MoveUp', 18)}
                            </button>
                            <button onclick="handleMovePage('down')" ${activePageIndex === pages.length - 1 ? 'disabled' : ''} class="p-2 text-gray-500 hover:bg-gray-100 rounded-md disabled:opacity-30">
                                ${IconSVG('MoveDown', 18)}
                            </button>
                            <button onclick="handleDeletePage()" class="p-2 text-red-400 hover:bg-red-50 hover:text-red-600 rounded-md ml-2">
                                ${IconSVG('Trash2', 18)}
                            </button>
                        </div>
                    </div>
                ` : `
                    <span class="text-sm text-gray-500">Page ${activePageIndex + 1} of ${pages.length}</span>
                `}
            </div>
        `;

        const sidebarHtml = `
            <div class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 ${!isEditing ? '-ml-64' : ''}">
                <div class="p-6 border-b border-gray-100">
                    <h1 class="text-xl font-serif font-bold text-gray-800 flex items-center gap-2">
                        ${IconSVG('Book', 20, 'text-blue-600')}
                        Photobook
                    </h1>
                    <p class="text-xs text-gray-400 mt-1">Memories with G (Shared)</p>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    ${pages.map((page, idx) => `
                        <div 
                            onclick="goToPage(${idx})"
                            class="p-3 rounded-lg cursor-pointer flex items-center gap-3 transition-all border ${
                                idx === activePageIndex 
                                ? 'bg-blue-50 border-blue-200 shadow-sm' 
                                : 'hover:bg-gray-50 border-transparent hover:border-gray-200'
                            }"
                        >
                            <div class="w-6 h-8 bg-gray-200 rounded border border-gray-300 flex-shrink-0 overflow-hidden">
                                ${page.layout === 'hero' ? '<div class="w-full h-1/2 bg-gray-400"></div>' : ''}
                                ${page.layout === 'split' ? '<div class="w-1/2 h-full bg-gray-400"></div>' : ''}
                                ${page.layout === 'grid' ? '<div class="w-full h-full grid grid-cols-2 gap-[1px]"><div class="bg-gray-400"></div><div class="bg-gray-400"></div></div>' : ''}
                                ${page.layout === 'scrapbook' ? '<div class="w-full h-full flex items-center justify-center"><div class="w-3 h-3 bg-gray-400 rotate-12"></div></div>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium truncate ${idx === activePageIndex ? 'text-blue-800' : 'text-gray-700'}">
                                    ${escapeHtml(page.content.title || `Page ${idx + 1}`)}
                                </p>
                                <p class="text-xs text-gray-400 capitalize">${page.layout} Layout</p>
                            </div>
                        </div>
                    `).join('')}
                    
                    <button 
                        onclick="handleAddPage()"
                        class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition-colors flex items-center justify-center gap-2 text-sm font-medium"
                    >
                        ${IconSVG('Plus', 16)} Add New Page
                    </button>
                </div>
                
                <div class="p-4 border-t border-gray-100 bg-gray-50">
                    <p class="font-medium text-sm text-blue-600 mb-1 flex items-center gap-1">
                        ${IconSVG('Users', 16)} Shared Book ID
                    </p>
                    <div class="flex items-center justify-between gap-2 bg-white border border-gray-300 rounded-lg p-2">
                        <p class="text-xs text-gray-700 break-words font-mono min-w-0 truncate">
                            <a href="${shareUrl}" target="_blank" class="text-blue-600 underline break-words">${shareUrl}</a>
                        </p>
                        <button 
                            onclick="copyAppIdToClipboard()"
                            class="p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-md flex-shrink-0 relative"
                            title="Copy Book ID"
                        >
                            ${IconSVG('Copy', 16)}
                             <span id="copy-message" class="absolute -top-6 right-0 bg-blue-600 text-white px-2 py-0.5 text-xs rounded opacity-0 transition-opacity">Copied!</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 italic">
                        Share this entire web link for collaboration.
                    </p>
                </div>
            </div>
        `;

        const canvasHtml = `
            <div class="flex-1 flex flex-col min-w-0 bg-gray-100 relative">
                ${toolbarHtml}
                <div class="flex-1 overflow-hidden flex items-center justify-center p-8 relative">
                    <button 
                        onclick="prevPage()"
                        ${activePageIndex === 0 ? 'disabled' : ''}
                        class="absolute left-4 z-10 p-3 bg-white/80 backdrop-blur-sm rounded-full shadow-lg text-gray-700 hover:bg-white hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed transition-all transform hover:scale-110"
                    >
                        ${IconSVG('ChevronLeft', 24)}
                    </button>
                    
                    <button 
                        onclick="nextPage()"
                        ${activePageIndex === pages.length - 1 ? 'disabled' : ''}
                        class="absolute right-4 z-10 p-3 bg-white/80 backdrop-blur-sm rounded-full shadow-lg text-gray-700 hover:bg-white hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed transition-all transform hover:scale-110"
                    >
                        ${IconSVG('ChevronRight', 24)}
                    </button>

                    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-lg overflow-hidden transition-all duration-500 ease-in-out transform photobook-page">
                        ${activePage ? renderLayout(activePage) : '<div class="flex items-center justify-center h-full text-gray-500">Select a page.</div>'}
                    </div>
                </div>
            </div>
        `;

        appElement.innerHTML = bannerHtml + sidebarHtml + canvasHtml;
        // Re-inject the global handlers since innerHTML rebuilds them
        setupGlobalHandlers();
    };

    // --- Global Setup ---
    window.handleUpdateContent = (field, value, index) => {
        handleUpdateContent(field, value, index);
    };
    window.triggerUpload = triggerUpload;
    window.handleAddPage = handleAddPage;
    window.handleDeletePage = handleDeletePage;
    window.handleMovePage = handleMovePage;
    window.handleChangeLayout = handleChangeLayout;
    window.saveBook = saveBook;
    window.copyAppIdToClipboard = copyAppIdToClipboard;
    window.retrySaveFromLocal = () => {
        try {
            const fallback = localStorage.getItem(`photobook:${appId}`);
            if (fallback) {
                const parsed = JSON.parse(fallback);
                if (parsed && parsed.pages) {
                    console.log('Retrying save from local fallback...');
                    saveBook(parsed.pages);
                }
            } else {
                console.warn('No local fallback found to retry.');
            }
        } catch (e) {
            console.error('Retry from local failed:', e?.message || e);
        }
    };
    window.dismissCloudBanner = () => {
        cloudSaveFailed = false;
        renderApp();
    };
    // Expose toggle function so inline onclicks can toggle module-scoped `isEditing` safely
    window.toggleEditMode = () => { isEditing = !isEditing; renderApp(); };

    // Navigation helpers (exposed for inline handlers)
    const prevPage = () => {
        if (activePageIndex > 0) {
            activePageIndex = Math.max(0, activePageIndex - 1);
            renderApp();
        }
    };

    const nextPage = () => {
        if (activePageIndex < pages.length - 1) {
            activePageIndex = Math.min(pages.length - 1, activePageIndex + 1);
            renderApp();
        }
    };

    const goToPage = (i) => {
        const idx = Number(i);
        if (!Number.isNaN(idx) && idx >= 0 && idx < pages.length) {
            activePageIndex = idx;
            renderApp();
        }
    };

    // expose navigation to window so inline onclicks can call them
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.goToPage = goToPage;


    const setupGlobalHandlers = () => {
        // Find and attach file input dynamically
        fileInputRef = document.createElement('input');
        fileInputRef.type = 'file';
        fileInputRef.className = 'hidden';
        fileInputRef.accept = 'image/*';
        fileInputRef.onchange = handleFileChange;
        const existingInput = document.getElementById('file-input');
        if (existingInput) {
            existingInput.remove();
        }
        document.body.appendChild(fileInputRef);

        // Attach click handler to the edit/preview toggle button if present
        const toggleBtn = document.getElementById('toggle-edit-btn');
        if (toggleBtn) {
            const newBtn = toggleBtn.cloneNode(true);
            toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);
            newBtn.addEventListener('click', () => {
                isEditing = !isEditing;
                renderApp();
            });
        }
    };
    
    // Start the application
    window.onload = () => {
        setupGlobalHandlers();
        initializeFirebase();
        renderApp();
    };

</script>
</body>
</html>